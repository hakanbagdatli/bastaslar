 <add name="con" connectionString="Data Source=213.159.7.73;Initial Catalog=raven_sunvalley;User ID=rsunvalley;Password=Liophin2024**" />


 https://sunvalleycyprus.com/raven/

 hakan@bastaslar.com
 1234

ftp:
sunvalleycyp
Sunvalley2024**

/*
DECLARE @SaleExecutiveId INT = 7 /*EÐER NULL ÝSE HEPSÝ*/
DECLARE @StartDate DATETIME = '20250101' /*EÐER NULL ÝSE HEPSÝ '20250101'*/
DECLARE @EndDate DATETIME = '20251231' /*EÐER NULL ÝSE HEPSÝ '20251231'*/
SET dateformat dmy;
/* 1. Bölüm: TOUCH (Arama/Callback) Verileri */
WITH TouchData AS (
    SELECT 
        _SaleExecutive, 
        COUNT(*) AS Touch 
    FROM (
        SELECT 
             CLLB.*
            ,AGN.Title AS _AgencyName
            ,CLLB.CreatedUser AS _SaleExecutiveID
            ,CONCAT(USR.Name, ' ', USR.Surname) AS _SaleExecutive
        FROM AgencyCallbacks CLLB
        LEFT JOIN Agencies AS AGN ON CLLB.AgencyID = AGN.id
        LEFT JOIN zUsers AS USR ON CLLB.CreatedUser = USR.id
        WHERE ISNULL(CLLB.isDeleted, 0) = 0
    ) AS tbl
    WHERE 1=1 AND (@SaleExecutiveId IS NULL OR _SaleExecutiveID = @SaleExecutiveId)
    AND (@StartDate IS NULL OR @EndDate IS NULL OR TRY_CONVERT(datetime, CreatedDate, 104) BETWEEN @StartDate AND @EndDate)
    GROUP BY _SaleExecutive
),

/* 2. Bölüm: COMPLETED & RESERVATION Verileri */
ReservationData AS (
    SELECT 
        _SaleExecutive, 
        SUM(CASE WHEN TurID = 1 THEN 1 ELSE 0 END) AS Completed, 
        SUM(CASE WHEN ISNULL(TurID, 0) <> 1 THEN 1 ELSE 0 END) AS Reservation 
    FROM (
        SELECT 
             RES.*
            ,REC.Title AS _ProjectName
            ,PLN.Title AS _PlanName
            ,INS.PNRCode AS _InspectionNumber
            ,AGN.Title AS _AgencyName, AGN.RelevantID AS _SaleExecutiveID
            ,CONCAT(RUSR.Name, ' ', RUSR.Surname) AS _SaleExecutive
            ,CUS.Name AS _CustomerName, CUS.Surname AS _CustomerSurname
            ,STA.Title AS _Statu
        FROM Reservations RES
        LEFT JOIN Inspections AS INS ON RES.InspectionNumber = INS.id
        LEFT JOIN GeneralRecords AS REC ON RES.ProjectID = REC.id
        LEFT JOIN GeneralPlans AS PLN ON RES.PlanID = PLN.id
        LEFT JOIN Agencies AS AGN ON RES.AgencyID = AGN.id
        LEFT JOIN zUsers AS RUSR ON AGN.RelevantID = RUSR.id
        LEFT JOIN Customers AS CUS ON RES.CustomerID = CUS.id
        LEFT JOIN zDefineDetails AS STA ON RES.Statu = STA.id
        WHERE ISNULL(RES.isDeleted, 0) = 0
    ) AS tbl
    WHERE 1=1 AND (@SaleExecutiveId IS NULL OR _SaleExecutiveID = @SaleExecutiveId)
    AND (@StartDate IS NULL OR @EndDate IS NULL OR TRY_CONVERT(datetime, CreatedDate, 104) BETWEEN @StartDate AND @EndDate)
    GROUP BY _SaleExecutive
),

/* 3. Bölüm: INSPECTION & PROPERTY VIEW Verileri */
InspectionData AS (
    SELECT 
        _SaleExecutive, 
        SUM(CASE WHEN ISNULL(TurID, 0) = 0 THEN 1 ELSE 0 END) AS Inspection, 
        SUM(CASE WHEN ISNULL(TurID, 0) <> 1 THEN 1 ELSE 0 END) AS PropertyView 
    FROM (
        SELECT 
             ISP.*
            ,AGN.Title AS _AgencyName, AGN.RelevantID AS _SaleExecutiveID
            ,CONCAT(USR.Name, ' ', USR.Surname) AS _SaleExecutive
            ,STA.Title AS _Statu
            ,MRM.Title AS _MeetingRoom
        FROM Inspections ISP
        LEFT JOIN Agencies AS AGN ON ISP.AgencyID = AGN.id
        LEFT JOIN zUsers AS USR ON AGN.RelevantID = USR.id
        LEFT JOIN zDefineDetails AS STA ON ISP.Statu = STA.id
        LEFT JOIN zDefineDetails AS MRM ON ISP.MeetingRoomID = MRM.id
        WHERE ISNULL(ISP.isDeleted, 0) = 0
    ) AS tbl
    WHERE 1=1 AND (@SaleExecutiveId IS NULL OR _SaleExecutiveID = @SaleExecutiveId)
    AND (@StartDate IS NULL OR @EndDate IS NULL OR TRY_CONVERT(datetime, CreatedDate, 104) BETWEEN @StartDate AND @EndDate)
    GROUP BY _SaleExecutive
)

/* SONUÇ: Tablolarý Birleþtirme */
SELECT 
    COALESCE(T._SaleExecutive, R._SaleExecutive, I._SaleExecutive) AS SalesExecutive,
    ISNULL(T.Touch, 0) AS Touch,
    ISNULL(R.Completed, 0) AS Completed,
    ISNULL(R.Reservation, 0) AS Reservation,
    ISNULL(I.Inspection, 0) AS Inspection,
    ISNULL(I.PropertyView, 0) AS PropertyView

FROM TouchData T
FULL OUTER JOIN ReservationData R ON T._SaleExecutive = R._SaleExecutive
FULL OUTER JOIN InspectionData I ON COALESCE(T._SaleExecutive, R._SaleExecutive) = I._SaleExecutive

-- Sýralama
ORDER BY SalesExecutive;
 
*/